name: üõ†Ô∏è Stages

on:
  push:
    branches:
      - pipeline
  workflow_dispatch:

env:
  DB_DATABASE: ${{ secrets.DB_DATABASE }}
  DB_USERNAME: ${{ secrets.DB_USERNAME }}
  DB_PASSWORD: ${{ secrets.DB_PASSWORD }}

jobs:
  init:
    name: üß± Init / Setup
    runs-on: ubuntu-latest

    outputs:
      uid: ${{ steps.export-uid.outputs.uid }}
      gid: ${{ steps.export-uid.outputs.gid }}

    steps:
      - name: üì• Checkout —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
        uses: actions/checkout@v4

      - name: üìù –°–æ–∑–¥–∞—Ç—å .env –∏ –∑–∞–ø–∏—Å–∞—Ç—å —Å–µ–∫—Ä–µ—Ç—ã
        working-directory: backend
        run: |
          cp .env.example .env
          echo "DB_DATABASE=${DB_DATABASE}" >> .env
          echo "DB_USERNAME=${DB_USERNAME}" >> .env
          echo "DB_PASSWORD=${DB_PASSWORD}" >> .env

      - name: üßë‚Äçüíª Export runner UID/GID
        id: export-uid
        run: |
          echo "uid=$(id -u)" >> $GITHUB_OUTPUT
          echo "gid=$(id -g)" >> $GITHUB_OUTPUT

      - name: üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–∞–±–æ—á–µ–µ –¥–µ—Ä–µ–≤–æ –∫–∞–∫ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç
        uses: actions/upload-artifact@v4
        with:
          name: source
          path: |
            backend/
            deployment/
            frontend/

  build:
    name: üì¶ Laravel Build
    runs-on: ubuntu-latest
    needs: init

    env:
      UID: ${{ needs.init.outputs.uid }}
      GID: ${{ needs.init.outputs.gid }}

    steps:
      - name: üì• –°–∫–∞—á–∞—Ç—å –∏—Å—Ö–æ–¥–Ω–∏–∫–∏
        uses: actions/download-artifact@v4
        with:
          name: source
          path: ./

      - name: üîß Build all containers
        working-directory: deployment
        run: |
          docker compose build \
            --build-arg UID=$UID \
            --build-arg GID=$GID

      - name: üöÄ –ë–∏–ª–¥ Laravel –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ
        working-directory: deployment
        run: |
          docker compose up -d

          docker compose run --rm composer sh -c "mkdir -p bootstrap/cache && chown -R $UID:$GID bootstrap/cache && chmod -R 775 bootstrap/cache"
          docker compose run --rm composer sh -c "mkdir -p resources/views"

          docker compose run --rm composer composer install --no-dev --optimize-autoloader
          docker compose run --rm composer php artisan config:cache
          docker compose run --rm composer php artisan route:cache
          docker compose run --rm composer php artisan view:cache

      - name: üíæ –ó–∞–≥—Ä—É–∑–∫–∞ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤ Laravel
        uses: actions/upload-artifact@v4
        with:
          name: laravel-build-artifacts
          path: |
            backend/vendor/
            backend/bootstrap/cache/
