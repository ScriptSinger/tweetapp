name: ðŸ› ï¸ Build Stage

on:
  push:
    branches:
      - pipeline
  workflow_dispatch:

env:
  DB_DATABASE: ${{ secrets.DB_DATABASE }}
  DB_USERNAME: ${{ secrets.DB_USERNAME }}
  DB_PASSWORD: ${{ secrets.DB_PASSWORD }}

jobs:
  build:
    name: ðŸ“¦ Laravel Build
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ
        uses: actions/checkout@v4

      - name: ðŸ“ Ð¡Ð¾Ð·Ð´Ð°Ñ‚ÑŒ .env Ð¸ Ð·Ð°Ð¿Ð¸ÑÐ°Ñ‚ÑŒ ÑÐµÐºÑ€ÐµÑ‚Ñ‹
        working-directory: backend
        run: |
          cp .env.example .env
          echo "DB_DATABASE=${DB_DATABASE}" >> .env
          echo "DB_USERNAME=${DB_USERNAME}" >> .env
          echo "DB_PASSWORD=${DB_PASSWORD}" >> .env

      - name: ðŸš€ Ð‘Ð¸Ð»Ð´ Laravel Ð² ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ðµ
        working-directory: deployment
        run: |
          docker compose up -d --build
          docker compose run --rm composer composer install --no-dev --optimize-autoloader
          docker compose run --rm composer php artisan config:cache
          docker compose run --rm composer php artisan route:cache
          docker compose run --rm composer php artisan view:cache

      - name: ðŸ’¾ Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° Ð°Ñ€Ñ‚ÐµÑ„Ð°ÐºÑ‚Ð¾Ð² Ð² GitHub
        uses: actions/upload-artifact@v4
        with:
          name: laravel-build-artifacts
          path: |
            backend/vendor/
            backend/bootstrap/cache/
